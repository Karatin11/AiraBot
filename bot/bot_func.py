from __future__ import annotations

import os
import re
import tempfile
from datetime import datetime
from tempfile import NamedTemporaryFile
from typing import TYPE_CHECKING

import aiohttp
import httpx
from aiogram import F, Router
from aiogram.fsm.state import State, StatesGroup
from aiogram.types import (
    CallbackQuery,
    FSInputFile,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    KeyboardButton,
    Message,
    ReplyKeyboardMarkup,
    ReplyKeyboardRemove,
)
from fpdf import FPDF

from .utils import get_phone, get_user_lang, get_user_phone, save_phone

if TYPE_CHECKING:
    from aiogram.fsm.context import FSMContext

router_func = Router()
API_URL = "http://127.0.0.1:8001"

BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
MEDIA_ROOT = os.path.join(BASE_DIR, "media")
DEFAULT_IMAGE_PATH = os.path.join(MEDIA_ROOT, "product_images/default.jpeg")
LOGO = os.path.join(MEDIA_ROOT, "logo.png")


class OrderState(StatesGroup):
    choosing_category = State()
    choosing_product = State()
    choosing_quantity = State()
    choosing_promotion = State()
    choosing_promotion_detail = State()  # ‚Üê –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ


def get_main_keyboard_multilang(language: str = "ru") -> ReplyKeyboardMarkup:
    if language == "ru":
        keyboard = [
            [KeyboardButton(text="üçΩ –ú–µ–Ω—é")],
            [KeyboardButton(text="üß∫ –ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞")],
            [KeyboardButton(text="üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã")],
            [KeyboardButton(text="‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏")],
        ]
    elif language == "uz":
        keyboard = [
            [KeyboardButton(text="üçΩ Menyu")],
            [KeyboardButton(text="üß∫ Savatim")],
            [KeyboardButton(text="üìû Kontaktlar")],
            [KeyboardButton(text="‚öô Sozlamalar")],
        ]
    elif language == "en":
        keyboard = [
            [KeyboardButton(text="üçΩ Menu")],
            [KeyboardButton(text="üß∫ My cart")],
            [KeyboardButton(text="üìû Contacts")],
            [KeyboardButton(text="‚öô Settings")],
        ]
    else:
        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä—É—Å—Å–∫–∏–π
        keyboard = [
            [KeyboardButton(text="üçΩ –ú–µ–Ω—é")],
            [KeyboardButton(text="üß∫ –ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞")],
            [KeyboardButton(text="üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã")],
            [KeyboardButton(text="‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏")],
        ]

    return ReplyKeyboardMarkup(keyboard=keyboard, resize_keyboard=True)


async def show_menu(message: Message, state: FSMContext = None) -> None:
    user_id = message.from_user.id

    # 1. –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —è–∑—ã–∫ –∏–∑ FSM
    lang = None
    if state:
        data = await state.get_data()
        lang = data.get("language")

    # 2. –ï—Å–ª–∏ –Ω–µ—Ç –≤ FSM ‚Äî –ø—Ä–æ–±—É–µ–º –∏–∑ —Ñ–∞–π–ª–∞
    if not lang:
        lang = get_language(user_id)

    # 3. –í—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ —è–∑—ã–∫—É
    if lang == "uz":
        text = "üìã Asosiy menyu"
    elif lang == "en":
        text = "üìã Main menu"
    else:
        text = "üìã –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"

    # 4. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
    keyboard = get_main_keyboard_multilang(lang)

    # 5. –û—Ç–≤–µ—Ç
    await message.answer(text, reply_markup=keyboard)


@router_func.message(F.text.in_(["üçΩ –ú–µ–Ω—é", "üçΩ Menyu", "üçΩ Menu"]))
async def handle_order(message: Message, state: FSMContext) -> None:
    user_id = message.from_user.id

    # 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —è–∑—ã–∫–∞ –∏–∑ FSM –∏–ª–∏ —Ñ–∞–π–ª–∞
    data = await state.get_data()
    lang = data.get("language") or get_language(user_id)

    # 2. –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    async with httpx.AsyncClient() as client:
        response = await client.get(f"{API_URL}/categories/")
        if response.status_code == 200:
            categories = response.json()
            if categories:
                keyboard = ReplyKeyboardMarkup(
                    keyboard=[[KeyboardButton(text=c["name"])] for c in categories]
                    + [
                        [
                            KeyboardButton(
                                text=(
                                    "‚¨Ö –ù–∞–∑–∞–¥"
                                    if lang == "ru"
                                    else "‚¨Ö Orqaga" if lang == "uz" else "‚¨Ö Back"
                                ),
                            ),
                        ],
                    ],
                    resize_keyboard=True,
                )
                await state.update_data(categories=categories)
                await state.set_state(OrderState.choosing_category)

                # –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                if lang == "uz":
                    text = "üìö Kategoriyani tanlang:"
                elif lang == "en":
                    text = "üìö Choose a category:"
                else:
                    text = "üìö –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:"

                await message.answer(text, reply_markup=keyboard)
            else:
                await message.answer(
                    (
                        "‚ùó Mavjud kategoriyalar yo‚Äòq."
                        if lang == "uz"
                        else (
                            "‚ùó No categories available."
                            if lang == "en"
                            else "‚ùó –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π."
                        )
                    ),
                )
        else:
            await message.answer(
                (
                    "‚ö†Ô∏è Kategoriyalarni yuklashda xatolik."
                    if lang == "uz"
                    else (
                        "‚ö†Ô∏è Error loading categories."
                        if lang == "en"
                        else "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π."
                    )
                ),
            )


@router_func.message(OrderState.choosing_category)
async def choose_category(message: Message, state: FSMContext):
    user_id = message.from_user.id
    data = await state.get_data()
    lang = data.get("language") or get_language(user_id)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ "–ù–∞–∑–∞–¥"
    if message.text in ["‚¨Ö –ù–∞–∑–∞–¥", "‚¨Ö Orqaga", "‚¨Ö Back"]:
        await state.clear()
        return await show_menu(message)

    categories = data.get("categories", [])
    selected = next((c for c in categories if c["name"] == message.text), None)

    if not selected:
        return await message.answer(
            (
                "‚ùó Noto‚Äòg‚Äòri kategoriya. Ro‚Äòyxatdan tanlang."
                if lang == "uz"
                else (
                    "‚ùó Invalid category. Please choose from the list."
                    if lang == "en"
                    else "‚ùó –ù–µ–≤–µ—Ä–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞."
                )
            ),
        )

    category_id = selected["id"]
    async with httpx.AsyncClient() as client:
        response = await client.get(f"{API_URL}/products/{category_id}/")
        if response.status_code == 200:
            products = response.json()
            if not products:
                return await message.answer(
                    (
                        "üì≠ Bu kategoriyada mahsulotlar yo‚Äòq."
                        if lang == "uz"
                        else (
                            "üì≠ No products in this category."
                            if lang == "en"
                            else "üì≠ –ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏."
                        )
                    ),
                )

            await state.update_data(products=products)
            await state.set_state(OrderState.choosing_product)

            back_text = (
                "‚¨Ö Orqaga" if lang == "uz" else "‚¨Ö Back" if lang == "en" else "‚¨Ö –ù–∞–∑–∞–¥"
            )
            keyboard = ReplyKeyboardMarkup(
                keyboard=[[KeyboardButton(text=p["name"])] for p in products]
                + [[KeyboardButton(text=back_text)]],
                resize_keyboard=True,
            )

            choose_text = (
                "üì¶ Mahsulotni tanlang:"
                if lang == "uz"
                else "üì¶ Choose a product:" if lang == "en" else "üì¶ –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç:"
            )

            await message.answer(choose_text, reply_markup=keyboard)
            return None
        return await message.answer(
            (
                "‚ùå Mahsulotlarni olishda xatolik."
                if lang == "uz"
                else (
                    "‚ùå Failed to fetch products."
                    if lang == "en"
                    else "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤."
                )
            ),
        )


@router_func.message(OrderState.choosing_product)
async def choose_product(message: Message, state: FSMContext):
    user_id = message.from_user.id
    data = await state.get_data()
    lang = data.get("language") or get_language(user_id)

    if message.text in ["‚¨Ö –ù–∞–∑–∞–¥", "‚¨Ö Orqaga", "‚¨Ö Back"]:
        await state.set_state(OrderState.choosing_category)
        return await handle_order(message, state)

    products = data.get("products", [])
    selected = next((p for p in products if p["name"] == message.text), None)

    if not selected:
        return await message.answer(
            (
                "‚ùó Noto‚Äòg‚Äòri mahsulot. Ro‚Äòyxatdan tanlang."
                if lang == "uz"
                else (
                    "‚ùó Invalid product. Please choose from the list."
                    if lang == "en"
                    else "‚ùó –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–≤–∞—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞."
                )
            ),
        )

    await state.update_data(selected_product=selected, quantity=1)

    # –£–¥–∞–ª–∏—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
    temp = await message.answer("üîÑ", reply_markup=ReplyKeyboardRemove())
    await temp.delete()

    # –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞
    await send_product_preview(message, selected, quantity=1, state=state)
    return None


async def send_product_preview(
    message: Message,
    product: dict,
    quantity: int,
    state: FSMContext,
) -> None:
    data = await state.get_data()
    user_id = message.from_user.id
    lang = data.get("language") or get_language(user_id)

    image_url_or_path = product.get("image")
    discount = product.get("discount_percent", 0)
    price = float(product["price"])

    if discount > 0:
        new_price = price * (1 - discount / 100)
        caption = {
            "ru": (
                f"<b>{product['name']}</b>\n"
                f"üí• <i>–°–∫–∏–¥–∫–∞ {discount}%</i>\n"
                f"üíµ –¶–µ–Ω–∞: ~{price:.2f}~ ‚Üí <b>{new_price:.2f}</b> —Å—É–º\n"
                f"üßÆ –ö–æ–ª-–≤–æ: {quantity}"
            ),
            "uz": (
                f"<b>{product['name']}</b>\n"
                f"üí• <i>Chegirma {discount}%</i>\n"
                f"üíµ Narx: ~{price:.2f}~ ‚Üí <b>{new_price:.2f}</b> so‚Äòm\n"
                f"üßÆ Miqdor: {quantity}"
            ),
            "en": (
                f"<b>{product['name']}</b>\n"
                f"üí• <i>Discount {discount}%</i>\n"
                f"üíµ Price: ~{price:.2f}~ ‚Üí <b>{new_price:.2f}</b> UZS\n"
                f"üßÆ Quantity: {quantity}"
            ),
        }.get(lang, "")
    else:
        caption = {
            "ru": (
                f"<b>{product['name']}</b>\n"
                f"üíµ –¶–µ–Ω–∞: {price:.2f} —Å—É–º\n"
                f"üßÆ –ö–æ–ª-–≤–æ: {quantity}"
            ),
            "uz": (
                f"<b>{product['name']}</b>\n"
                f"üíµ Narx: {price:.2f} so‚Äòm\n"
                f"üßÆ Miqdor: {quantity}"
            ),
            "en": (
                f"<b>{product['name']}</b>\n"
                f"üíµ Price: {price:.2f} UZS\n"
                f"üßÆ Quantity: {quantity}"
            ),
        }.get(lang, "")

    # –§–æ—Ç–æ
    try:
        if image_url_or_path and image_url_or_path.startswith("http"):
            async with aiohttp.ClientSession() as session:
                async with session.get(image_url_or_path) as resp:
                    if resp.status == 200:
                        with NamedTemporaryFile(delete=False, suffix=".jpg") as tmp:
                            tmp.write(await resp.read())
                            photo_path = tmp.name
                    else:
                        photo_path = DEFAULT_IMAGE_PATH
        else:
            photo_path = (
                os.path.normpath(os.path.join(MEDIA_ROOT, image_url_or_path))
                if image_url_or_path
                else DEFAULT_IMAGE_PATH
            )
            if not os.path.isfile(photo_path):
                photo_path = DEFAULT_IMAGE_PATH

        photo = FSInputFile(photo_path)
    except Exception:
        photo = FSInputFile(DEFAULT_IMAGE_PATH)

    # –ö–Ω–æ–ø–∫–∏ –ø–æ —è–∑—ã–∫–∞–º
    add_text = {"ru": "üõí –î–æ–±–∞–≤–∏—Ç—å", "uz": "üõí Qo‚Äòshish", "en": "üõí Add"}[lang]
    back_text = {"ru": "‚¨Ö –ù–∞–∑–∞–¥", "uz": "‚¨Ö Orqaga", "en": "‚¨Ö Back"}[lang]

    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="‚ûñ", callback_data="decrease"),
                InlineKeyboardButton(text=str(quantity), callback_data="noop"),
                InlineKeyboardButton(text="‚ûï", callback_data="increase"),
            ],
            [InlineKeyboardButton(text=add_text, callback_data="addtocart")],
            [InlineKeyboardButton(text=back_text, callback_data="go_back")],
        ],
    )

    await message.answer_photo(
        photo=photo,
        caption=caption,
        reply_markup=keyboard,
        parse_mode="HTML",
    )


from .utils import get_language


@router_func.callback_query(F.data == "go_back")
async def go_back_handler(callback: CallbackQuery, state: FSMContext) -> None:
    await callback.message.delete()
    await state.set_state(OrderState.choosing_product)

    user_id = callback.from_user.id
    data = await state.get_data()
    products = data.get("products", [])
    lang = data.get("language") or get_language(user_id)

    # –ü–µ—Ä–µ–≤–æ–¥—ã
    choose_text = {
        "ru": "üì¶ –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç:",
        "uz": "üì¶ Mahsulotni tanlang:",
        "en": "üì¶ Choose a product:",
    }.get(lang, "üì¶ –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç:")

    not_found_text = {
        "ru": "‚ùå –ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",
        "uz": "‚ùå Mahsulotlar topilmadi.",
        "en": "‚ùå Products not found.",
    }.get(lang, "‚ùå –ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")

    back_button_text = {"ru": "‚¨Ö –ù–∞–∑–∞–¥", "uz": "‚¨Ö Orqaga", "en": "‚¨Ö Back"}.get(
        lang,
        "‚¨Ö –ù–∞–∑–∞–¥",
    )

    if products:
        keyboard = ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton(text=p["name"])] for p in products]
            + [[KeyboardButton(text=back_button_text)]],
            resize_keyboard=True,
        )
        await callback.message.answer(choose_text, reply_markup=keyboard)
    else:
        await callback.message.answer(not_found_text)


@router_func.callback_query(F.data.in_(["increase", "decrease", "addtocart"]))
async def handle_quantity_buttons(call: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    product = data.get("selected_product")
    quantity = data.get("quantity", 1)
    lang = data.get("language") or get_language(call.from_user.id)

    # –ü–µ—Ä–µ–≤–æ–¥—ã
    phone_missing = {
        "ru": "üì± –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ ‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏",
        "uz": "üì± ‚öô Sozlamalardan raqamni kiriting",
        "en": "üì± Please enter your phone in ‚öô Settings",
    }.get(lang, "üì± –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ ‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏")

    success_text = {
        "ru": "‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É",
        "uz": "‚úÖ Mahsulot savatga qo‚Äòshildi",
        "en": "‚úÖ Product added to cart",
    }.get(lang, "‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É")

    error_text = {
        "ru": "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É.",
        "uz": "‚ùå Savatga qo‚Äòshishda xatolik yuz berdi.",
        "en": "‚ùå Error adding product to cart.",
    }.get(lang, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É.")

    if call.data == "increase":
        quantity += 1
    elif call.data == "decrease":
        quantity = max(1, quantity - 1)
    elif call.data == "addtocart":
        phone = await get_user_phone(call.message, state)
        if not phone:
            return await call.message.answer(phone_missing)

        async with httpx.AsyncClient() as client:
            response = await client.post(
                f"{API_URL}/cart/add/",
                json={"phone": phone, "product_id": product["id"], "quantity": quantity},
            )

        if response.status_code == 200:
            await call.message.edit_reply_markup()
            await call.message.answer(
                success_text,
                reply_markup=get_main_keyboard_multilang(lang),
            )
        else:
            await call.message.answer(error_text)

        await state.clear()
        await state.update_data(language=lang, phone=phone)

        return None
    await state.update_data(quantity=quantity)
    await call.message.delete()
    await send_product_preview(call.message, product, quantity, state)
    await call.answer()
    return None


@router_func.message(F.text.in_(["üß∫ –ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞", "üß∫ Savatim", "üß∫ My cart"]))
async def handle_cart(message: Message, state: FSMContext):
    phone = await get_user_phone(message, state)
    if not phone:
        return await message.answer(
            {
                "ru": "‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä.",
                "uz": "‚ùó Iltimos, telefon raqamingizni kiriting.",
                "en": "‚ùó Please enter your phone number.",
            }.get(await get_user_lang(state, message.from_user.id), "‚ùó –û—à–∏–±–∫–∞"),
        )

    async with httpx.AsyncClient(timeout=5.0) as client:
        response = await client.get(f"{API_URL}/cart/{phone}/")

    lang = await get_user_lang(state, message.from_user.id)

    if response.status_code != 200:
        return await message.answer(
            {
                "ru": "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã.",
                "uz": "‚ùå Savatchani yuklashda xatolik.",
                "en": "‚ùå Failed to load your cart.",
            }.get(lang, "‚ùå –û—à–∏–±–∫–∞"),
        )

    data = response.json()
    items = data.get("items", [])
    total = data.get("total_price", 0)

    if not items:
        return await message.answer(
            {
                "ru": "üß∫ –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.",
                "uz": "üß∫ Savatchangiz bo‚Äòsh.",
                "en": "üß∫ Your cart is empty.",
            }.get(lang, "üß∫ –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞."),
        )

    # –ù–∞–∑–≤–∞–Ω–∏—è –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
    headers = {
        "ru": f"üß∫ –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ ({phone}):\n",
        "uz": f"üß∫ Savatchangiz ({phone}):\n",
        "en": f"üß∫ Your cart ({phone}):\n",
    }

    currency = "so'm" if lang == "uz" else "—Å—É–º"

    text = headers.get(lang, headers["ru"])

    for item in items:
        name = strip_emojis(item["name"])[:25]
        quantity = item["quantity"]
        price = float(item["price"])
        discount = float(item.get("discount_percent", 0))

        if discount > 0:
            discounted_price = price * (1 - discount / 100)
            subtotal = quantity * discounted_price
            text += (
                f"‚Ä¢ {name} x{quantity} = {subtotal:.2f} {currency}\n"
                f"  <i>üí• {discount}% {price:.2f} ‚Üí {discounted_price:.2f}</i>\n"
            )
        else:
            subtotal = quantity * price
            text += f"‚Ä¢ {name} x{quantity} = {subtotal:.2f} {currency}\n"

    total_label = {
        "ru": "üí∞ <b>–ò—Ç–æ–≥–æ:</b>",
        "uz": "üí∞ <b>Jami:</b>",
        "en": "üí∞ <b>Total:</b>",
    }.get(lang, "üí∞ <b>–ò—Ç–æ–≥–æ:</b>")

    text += f"\n{total_label} <code>{total:.2f}</code> {currency}\n"

    order_button_text = {
        "ru": "üõí –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑",
        "uz": "üõí Buyurtma berish",
        "en": "üõí Place Order",
    }.get(lang, "üõí –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑")

    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text=order_button_text, callback_data="make_order")],
        ],
    )

    await message.answer(text, reply_markup=keyboard, parse_mode="HTML")
    return None


ADMIN_CHAT_IDS = [7591006387]


class PDF(FPDF):
    def __init__(self) -> None:
        super().__init__(format=(80, 300))  # 80 –º–º —à–∏—Ä–∏–Ω–∞, –≤—ã—Å–æ—Ç–∞ –∞–≤—Ç–æ
        font_path = "/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf"
        self.add_font("DejaVu", "", font_path, uni=True)
        self.set_font("DejaVu", "", 9)  # —á—É—Ç—å –º–µ–Ω—å—à–µ —à—Ä–∏—Ñ—Ç
        self.set_auto_page_break(auto=True, margin=10)
        self.add_page()

    def line_text(self, text: str, h=5) -> None:
        self.cell(0, h, text, ln=True, align="C")  # –í–°–ï–ì–î–ê –ü–û –¶–ï–ù–¢–†–£


def strip_emojis(text: str) -> str:
    return re.sub(r"[^\w\s.,:;!?()%/\-+‚Ññ\"\'=–ê-–Ø–∞-—è—ë–Å]", "", text)


def split_message(text: str, max_length: int = 4000) -> list[str]:
    parts = []
    while len(text) > max_length:
        split_index = text.rfind("\n", 0, max_length)
        if split_index == -1:
            split_index = max_length
        parts.append(text[:split_index].strip())
        text = text[split_index:].strip()
    parts.append(text)
    return parts


async def restore_basic_context(state: FSMContext, lang: str, phone: str) -> None:
    await state.clear()
    await state.update_data(language=lang, phone=phone)


@router_func.callback_query(F.data == "make_order")
async def process_order(call: CallbackQuery, state: FSMContext):
    lang = await get_user_lang(state, call.from_user.id)
    phone = await get_user_phone(call.message, state)
    if not phone:
        return await call.message.answer(
            {
                "ru": "‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä.",
                "uz": "‚ùó Iltimos, telefon raqamingizni kiriting.",
                "en": "‚ùó Please enter your phone number.",
            }.get(lang, "‚ùó –û—à–∏–±–∫–∞"),
        )

    async with httpx.AsyncClient(timeout=5.0) as client:
        order_response = await client.post(f"{API_URL}/order/", json={"phone": phone})
        if order_response.status_code != 200:
            try:
                error = order_response.json().get(
                    "error",
                    {
                        "ru": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.",
                        "uz": "Xatolik yuz berdi.",
                        "en": "An error occurred.",
                    }[lang],
                )
            except Exception:
                error = {
                    "ru": "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                    "uz": "Buyurtma yaratilmadi. Keyinroq urinib ko‚Äòring.",
                    "en": "Could not create order. Try again later.",
                }[lang]
            return await call.message.answer(f"‚ùå {error}")

        order_data = order_response.json()
        order_id = order_data["order_id"]
        total = order_data["total"]
        items = order_data.get("items", [])

        company_response = await client.get("http://127.0.0.1:8000/company/1/")
        if company_response.status_code == 200:
            company = company_response.json()
            company_name = company.get(
                "name",
                {"ru": "–ö–æ–º–ø–∞–Ω–∏—è", "uz": "Kompaniya", "en": "Company"}[lang],
            )
            company_phone = company.get("phone", "N/A")
        else:
            company_name = {"ru": "–ö–æ–º–ø–∞–Ω–∏—è", "uz": "Kompaniya", "en": "Company"}[lang]
            company_phone = "N/A"

    # –ß–µ–∫ ‚Äî —Ç–µ–∫—Å—Ç

    lines = [
        {"ru": "üßæ –í–∞—à –∑–∞–∫–∞–∑\n", "uz": "üßæ Buyurtmangiz\n", "en": "üßæ Your order\n"}[
            lang
        ],
        f"üè¢ {company_name}",
        f"üìû +998 {company_phone}",
        f"üì± –ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞ {order_data.get('phone', phone)}",
        "-" * 30,
        {
            "ru": f"üì¶ –ó–∞–∫–∞–∑ ‚Ññ: {order_id}",
            "uz": f"üì¶ Buyurtma raqami: {order_id}",
            "en": f"üì¶ Order ID: {order_id}",
        }[lang],
        f"üïì {datetime.now().strftime('%d.%m.%Y %H:%M')}",
        "-" * 30,
        {"ru": "üõç –¢–æ–≤–∞—Ä—ã:", "uz": "üõç Mahsulotlar:", "en": "üõç Products:"}[lang],
    ]

    for item in items:
        name = item["name"]
        quantity = item["quantity"]
        price = float(item["price"])
        discount = float(item.get("discount_percent", 0))
        if discount > 0:
            new_price = price * (1 - discount / 100)
            subtotal = quantity * new_price
            lines.append(
                f"‚Ä¢ {name} x{quantity} = {subtotal:.2f} —Å—É–º\n  üí• {discount}%: {price:.2f} ‚Üí {new_price:.2f}",
            )
        else:
            subtotal = quantity * price
            lines.append(f"‚Ä¢ {name} x{quantity} = {subtotal:.2f} —Å—É–º")

    lines.append("-" * 30)
    lines.append(
        {
            "ru": f"üí∞ –ò—Ç–æ–≥–æ: {total:.2f} —Å—É–º",
            "uz": f"üí∞ Jami: {total:.2f} so'm",
            "en": f"üí∞ Total: {total:.2f} sum",
        }[lang],
    )
    lines.append(
        {
            "ru": "üôè –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!",
            "uz": "üôè Buyurtma uchun rahmat!",
            "en": "üôè Thank you for your order!",
        }[lang],
    )

    # –£–¥–∞–ª–∏—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    if call.message.reply_markup:
        await call.message.edit_reply_markup(reply_markup=None)

    # –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ–∫–∞
    for part in split_message("\n".join(lines)):
        await call.message.answer(part)

    # –ü–æ–¥–ø–∏—Å—å
    await call.message.answer(
        {
            "ru": "üìã –í—ã—à–µ ‚Äî –≤–∞—à —á–µ–∫.",
            "uz": "üìã Yuqorida ‚Äî chekingiz.",
            "en": "üìã Here's your receipt above.",
        }[lang],
        reply_markup=get_main_keyboard_multilang(lang),
    )

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF —á–µ–∫–∞
    pdf = PDF()
    logo = LOGO
    pdf.image(logo, x=(80 - 40) / 2, w=40)
    pdf.ln(3)
    pdf.line_text("–ö–ê–°–°–û–í–´–ô –ß–ï–ö / CHIQARILGAN CHEK / RECEIPT", 6)
    pdf.line_text("-" * 66)
    pdf.line_text(strip_emojis(company_name))
    pdf.line_text(f"–¢–µ–ª.: +998 {company_phone}")
    pdf.line_text(f"–ö–ª–∏–µ–Ω—Ç: {order_data.get('phone', phone)}")
    pdf.line_text(f"‚Ññ: {order_id}")
    pdf.line_text(datetime.now().strftime("%d.%m.%Y %H:%M"))
    pdf.line_text("-" * 66)
    pdf.line_text("–¢–æ–≤–∞—Ä—ã / Mahsulotlar / Products:")

    for item in items:
        name = strip_emojis(item["name"])[:25]
        quantity = item["quantity"]
        price = float(item["price"])
        discount = float(item.get("discount_percent", 0))
        if discount > 0:
            new_price = price * (1 - discount / 100)
            subtotal = quantity * new_price
            pdf.line_text(f"{name} x{quantity} = {subtotal:.2f}")
            pdf.line_text(f"–°–∫–∏–¥–∫–∞ {discount}%: {price:.2f} ‚Üí {new_price:.2f}")
        else:
            subtotal = quantity * price
            pdf.line_text(f"{name} x{quantity} = {subtotal:.2f}")

    pdf.line_text("-" * 66)
    pdf.line_text(f"–ò–¢–û–ì–û: {total:.2f} —Å—É–º")
    pdf.line_text("–°–ü–ê–°–ò–ë–û –ó–ê –í–ù–ò–ú–ê–ù–ò–ï")

    with tempfile.NamedTemporaryFile(delete=False, suffix=".pdf") as tmp_file:
        pdf_path = tmp_file.name
        pdf.output(pdf_path)

    pdf_filename = f"order_{order_id}.pdf"
    pdf_path = os.path.join(tempfile.gettempdir(), pdf_filename)
    pdf.output(pdf_path)

    for admin_id in ADMIN_CHAT_IDS:
        try:
            await call.bot.send_document(
                admin_id,
                FSInputFile(pdf_path),
                caption="üì• –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ (PDF —á–µ–∫)",
            )
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ PDF –∞–¥–º–∏–Ω—É {admin_id}: {e}")

    os.remove(pdf_path)
    await restore_basic_context(state, lang, phone)
    return None


@router_func.message(F.text.in_(["üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã", "üìû Kontaktlar", "üìû Contacts"]))
async def handle_contacts(message: Message, state: FSMContext) -> None:
    lang = await get_user_lang(state, message.from_user.id)

    try:
        async with httpx.AsyncClient(timeout=5.0) as client:
            response = await client.get("http://127.0.0.1:8000/company/1/")

        if response.status_code == 200:
            company = response.json()
            company_name = (
                company.get("name")
                or {"ru": "–ö–æ–º–ø–∞–Ω–∏—è", "uz": "Kompaniya", "en": "Company"}[lang]
            )
            company_phone = company.get("phone") or "N/A"
        else:
            print("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏: –∫–æ–¥", response.status_code)
            company_name = {"ru": "–ö–æ–º–ø–∞–Ω–∏—è", "uz": "Kompaniya", "en": "Company"}[lang]
            company_phone = "N/A"

    except Exception as e:
        print("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫–æ–º–ø–∞–Ω–∏–∏:", e)
        company_name = {"ru": "–ö–æ–º–ø–∞–Ω–∏—è", "uz": "Kompaniya", "en": "Company"}[lang]
        company_phone = "N/A"

    contact_texts = {
        "ru": (
            "üìû <b>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</b>\n\n"
            f"üè¢ <b>{company_name}</b>\n"
            f"üì± –¢–µ–ª–µ—Ñ–æ–Ω: <code>+998 {company_phone}</code>\n\n"
            "üí¨ –ú—ã –≤—Å–µ–≥–¥–∞ –Ω–∞ —Å–≤—è–∑–∏!"
        ),
        "uz": (
            "üìû <b>Aloqa ma'lumotlari</b>\n\n"
            f"üè¢ <b>{company_name}</b>\n"
            f"üì± Telefon: <code>+998 {company_phone}</code>\n\n"
            "üí¨ Biz doimo aloqadamiz!"
        ),
        "en": (
            "üìû <b>Contact Information</b>\n\n"
            f"üè¢ <b>{company_name}</b>\n"
            f"üì± Phone: <code>+998 {company_phone}</code>\n\n"
            "üí¨ We are always in touch!"
        ),
    }

    await message.answer(contact_texts[lang], parse_mode="HTML")


def get_settings_keyboard(lang: str) -> InlineKeyboardMarkup:
    texts = {
        "ru": {
            "lang": "üîÑ –ü–æ–º–µ–Ω—è—Ç—å —è–∑—ã–∫",
            "phone": "‚òéÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä",
            "back": "üîô –ù–∞–∑–∞–¥",
        },
        "uz": {
            "lang": "üîÑ Tilni o‚Äòzgartirish",
            "phone": "‚òéÔ∏è Raqamni o‚Äòzgartirish",
            "back": "üîô Orqaga",
        },
        "en": {
            "lang": "üîÑ Change language",
            "phone": "‚òéÔ∏è Change phone",
            "back": "üîô Back",
        },
    }

    t = texts.get(lang, texts["ru"])
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text=t["lang"], callback_data="change_language")],
            [InlineKeyboardButton(text=t["phone"], callback_data="change_phone")],
            [InlineKeyboardButton(text=t["back"], callback_data="back_to_main")],
        ],
    )


@router_func.callback_query(F.data == "back_to_main")
async def back_to_main_menu(call: CallbackQuery, state: FSMContext) -> None:
    lang = await get_user_lang(state, call.from_user.id)
    await call.message.delete()
    await call.message.answer("üîô", reply_markup=get_main_keyboard_multilang(lang))
    await call.answer()


def get_language_keyboard() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data="lang_ru"),
                InlineKeyboardButton(text="üá∫üáø O‚Äòzbek", callback_data="lang_uz"),
                InlineKeyboardButton(text="üá¨üáß English", callback_data="lang_en"),
            ],
            [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="back_to_settings")],
        ],
    )


@router_func.callback_query(F.data == "back_to_settings")
async def back_to_settings(call: CallbackQuery, state: FSMContext) -> None:
    lang = await get_user_lang(state, call.from_user.id)

    await call.message.edit_text(
        {"ru": "‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏", "uz": "‚öô Sozlamalar", "en": "‚öô Settings"}[lang],
        reply_markup=get_settings_keyboard(lang),
    )
    await call.answer()


@router_func.message(
    F.text.in_({"/settings", "‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏", "‚öô Sozlamalar", "‚öô Settings"}),
)
async def settings_handler(msg: Message, state: FSMContext) -> None:
    lang = await get_user_lang(state, msg.from_user.id)

    # –£–¥–∞–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    await msg.answer(
        "–í—ã –ø–µ—Ä–µ—à–ª–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏",
        reply_markup=ReplyKeyboardRemove(),
    )  # —Å–∫—Ä—ã–≤–∞–µ—Ç –æ–±—ã—á–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∞–º–∏
    await msg.answer(
        {"ru": "‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏", "uz": "‚öô Sozlamalar", "en": "‚öô Settings"}[lang],
        reply_markup=get_settings_keyboard(lang),
    )


@router_func.callback_query(F.data == "change_language")
async def change_language_handler(call: CallbackQuery, state: FSMContext) -> None:
    await call.message.edit_text(
        "üåê –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Tilni tanlang / Select language:",
        reply_markup=get_language_keyboard(),
    )
    await call.bot.send_chat_action(call.from_user.id, "typing")

    await call.answer()


@router_func.callback_query(F.data.startswith("lang_"))
async def set_language_handler(call: CallbackQuery, state: FSMContext) -> None:
    lang_code = call.data.split("_")[1]
    user_id = call.from_user.id
    phone = get_phone(user_id) or ""

    save_phone(user_id, phone, lang_code)
    await state.update_data(language=lang_code)

    confirmation = {
        "ru": "‚úÖ –Ø–∑—ã–∫ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ —Ä—É—Å—Å–∫–∏–π",
        "uz": "‚úÖ Til o‚Äòzbek tiliga o‚Äòzgartirildi",
        "en": "‚úÖ Language changed to English",
    }

    await call.message.edit_text(
        confirmation[lang_code],
        reply_markup=get_settings_keyboard(lang_code),
    )
    await call.answer()


@router_func.callback_query(F.data == "change_phone")
async def change_phone_handler(call: CallbackQuery, state: FSMContext) -> None:
    lang = await get_user_lang(state, call.from_user.id)

    text = {
        "ru": "üì≤ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–∏–º –Ω–æ–º–µ—Ä–æ–º.",
        "uz": "üì≤ Iltimos, raqamingizni yuborish uchun tugmani bosing.",
        "en": "üì≤ Please tap the button below to share your phone number.",
    }[lang]

    keyboard = ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="üì± –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–æ–º–µ—Ä–æ–º", request_contact=True)]],
        resize_keyboard=True,
        one_time_keyboard=True,
    )

    await call.message.delete()
    await call.message.answer(text, reply_markup=keyboard)
    await call.answer()


@router_func.message(F.contact)
async def process_contact(msg: Message, state: FSMContext) -> None:
    contact = msg.contact
    user_id = msg.from_user.id
    phone = contact.phone_number

    lang = await get_user_lang(state, user_id)
    save_phone(user_id, phone, lang)
    await state.update_data(phone=phone)

    confirmation = {
        "ru": f"‚úÖ –ù–æ–º–µ—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {phone}",
        "uz": f"‚úÖ Raqam saqlandi: {phone}",
        "en": f"‚úÖ Phone saved: {phone}",
    }[lang]

    await msg.answer(confirmation, reply_markup=get_main_keyboard_multilang(lang))
